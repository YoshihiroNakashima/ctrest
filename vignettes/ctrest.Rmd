---
title: "ctrest"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ctrest}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## パッケージの概要と前準備

　"ctrest"は，RESTモデルによる密度推定を簡単に行うためのRパッケージです．RESTモデルとは，自動撮影カメラ（カメラトラップ）によって得られた動画データに基づいて地上性哺乳類・鳥類の密度推定を行うための統計モデルです．モデルの詳細については，[Nakashima et al. (2018)](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2664.13059)と[Nakashima et al. (2024)](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2664.13059)をご参照ください．また，データの準備までのプロセスについては，XXXを参照してください．

　パッケージは，以下のような関数を含みます．

-   **データの前処理**：推定用の関数が利用できる形に整形するための前処理を行います．

-   **密度推定：**パラメータの推定手法によって異なる関数を定義しています．

    -   **最尤法**：関数名の最初にmle_がついている関数です．地点全体の平均的な密度を推定する場合のみに対応しています（共変量やランダム効果を含める形にはしていません）．

    -   **ベイズ法**：関数名の最初にbayes_がついている関数です．確率的プログラミング言語Stanを用いたMCMC法を利用しています．事前にRtoolをお手持ちのパソコンにインストールして，cmdstanrを使える状態にする必要があります（cmdstanrのインストールに関しては，他サイトを参考にしてください）．

## データの**前処理**

### ２つの元データ

　ここでは以下の２つのCSVファイルに整然データとして入力されていることを前提とします．

-   **撮影データ**：各行に１回の撮影情報が入力されたデータです．合計で100回の撮影があった場合は，100行の表（変数名も含めれば101行）になります．最低限必要なのは，地点ID，撮影日時，撮影された動物の種名，滞在時間の測定値，打ち切りの有無です．欠損値にはNAを入力します[^1]．

-   **カメラ地点データ**：各行に各カメラ地点の情報が入力されたデータです．100地点にカメラを設置した場合，100行の表（変数名も含めれば101行）になります．カメラ地点データで最低限必要なのは，設置点IDです．場合によっては，カメラの稼働開始日時（設置日時）や終了日時（回収日，もしくは，途中で稼働しなくなった場合は最後の撮影日時），各地点の環境共変量などが入力されます．

[^1]: RではNAはNot Availableの意味する特殊な予約語です．これに限らず欠損データは，半角英数字でNAとしてください．

　以下，パッケージに含まれているexampleデータを使って説明します．

```{r setup}
library(ctrest)
detection_data # 撮影データ
```

撮影データには，StationID（地点ID），DateTime（撮影日時），Species（撮影された動物種名），nfocal（有効範囲に入った回数），Stay（有効範囲内の滞在時間），Cens（滞在時間の打ち切りの有=1，無=0）が入力されています．

```{r}
station_data # カメラ設置点データ
```

カメラ設置点データには，ここでは，StationID（地点ID）のみが入力されています．カメラ稼働期間は，後で追加します．

### 撮影枚数の整理

２つのデータに基づいて，各種の撮影枚数を集計します．このための関数がformat_npass_covsです．exampleデータでやってみます．

```{r}
npass_data <- format_npass_covs(detection_data = detection_data, # 撮影データの名前
                                station_data = station_data, # カメラ設置点データ名
                                col_name_station = "station", # 地点IDの入った列名
                                col_name_species = "species", # 種名の入った列名
                                target_species = "A") # 対象種名
```

このように２つのソースデータを地点ごとに統合してくれます．Npassに入っているのは，各地点で通過回数の合計です．もちろん，撮影がなかった地点のNpassは0になります．

### カメラ稼働期間の追加

　次にカメラ稼働期間をこのデータに追加します．ここでは，調査開始時は，最初の撮影日時，終了時は，最後の撮影日時と一致すると仮定しています．RESTでは，有効範囲の撮影を行うので，最初の撮影日時が稼働開始と一致することは多いはずです．終了時にカメラの電池が残っているものに関しては，回収時に撮影を行っておくと，以下の関数を使って稼働期間を集計できます．

```{r}
npass_effort_data <- add_effort(detection_data = detection_data,
                                npass_data = npass_data,
                                col_name_station = "station",
                                col_name_datetime = "datetime")
```

### 滞在時間の取得

```{r}
stay_data <- format_stay(detection_data,
                         col_name_station = "station",
                         col_name_species = "species",
                         col_name_stay = "stay",
                         col_name_cens = "cens",
                         target_species = "A")
```

滞在時間は，撮影データに

## 植生タイプごとの密度推定
